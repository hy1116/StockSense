# Argo ML Pipeline - PVC, CronWorkflow
# RBAC 설정은 argo-rbac.yaml에서 관리
---
# ML 데이터 저장용 PVC (수집 → 전처리 → 학습 간 데이터 공유)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ml-data-pvc
  namespace: stocksense
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: ml-pipeline-daily
  namespace: stocksense
spec:
  schedule: "0 6 * * *"
  timezone: "Asia/Seoul"
  concurrencyPolicy: Forbid
  workflowSpec:
    serviceAccountName: default
    entrypoint: ml-steps
    ttlStrategy:
      secondsAfterCompletion: 300 
      secondsAfterSuccess: 60
      secondsAfterFailure: 3600
    # 모든 Pod에서 공유할 볼륨 정의
    volumes:
    - name: ml-data
      persistentVolumeClaim:
        claimName: ml-data-pvc
    templates:
    - name: ml-steps
      steps:
      - - name: init-collection-stocks
          template: run-task
          arguments: { parameters: [{name: cmd, value: "python -m ml.init_collection_stocks --sync --top 100"}] }
      - - name: historical-data
          template: run-task
          arguments: { parameters: [{name: cmd, value: "python -m ml.collect_historical_data"}] }
      - - name: data-ingestion
          template: run-task
          arguments: { parameters: [{name: cmd, value: "python -m ml.collect_daily_data"}] }
      - - name: preprocessing
          template: run-task
          arguments: { parameters: [{name: cmd, value: "python -m ml.preprocess_data"}] }
      - - name: training
          template: run-task
          arguments: { parameters: [{name: cmd, value: "python -m ml.train_model"}] }

    - name: run-task
      inputs:
        parameters: [{name: cmd}]
      container:
        image: stocksense-ml:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args: ["{{inputs.parameters.cmd}}"]
        env:
        - name: TZ
          value: "Asia/Seoul"
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: stocksense-config
              key: DATABASE_URL
        - name: KIS_APP_KEY
          valueFrom:
            secretKeyRef:
              name: stocksense-secret
              key: KIS_APP_KEY
        - name: KIS_APP_SECRET
          valueFrom:
            secretKeyRef:
              name: stocksense-secret
              key: KIS_APP_SECRET
        - name: KIS_ACCOUNT_NUMBER
          valueFrom:
            secretKeyRef:
              name: stocksense-secret
              key: KIS_ACCOUNT_NUMBER
        - name: KIS_ACCOUNT_PRODUCT_CODE
          valueFrom:
            secretKeyRef:
              name: stocksense-secret
              key: KIS_ACCOUNT_PRODUCT_CODE
        - name: KIS_USE_MOCK
          value: "True"
        - name: KIS_BASE_URL
          value: "https://openapi.koreainvestment.com:9443"
        - name: REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: stocksense-config
              key: REDIS_HOST
        - name: REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: stocksense-config
              key: REDIS_PORT
        volumeMounts:
        - name: ml-data
          mountPath: /app/data
---
# 뉴스 크롤링 CronWorkflow (1시간마다 실행)
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: news-crawler-hourly
  namespace: stocksense
spec:
  schedule: "0/5 * * * *"  # 매시 정각
  timezone: "Asia/Seoul"
  concurrencyPolicy: Forbid
  workflowSpec:
    serviceAccountName: default
    entrypoint: news-crawl-steps
    ttlStrategy:
      secondsAfterCompletion: 300
      secondsAfterSuccess: 60
      secondsAfterFailure: 3600
    templates:
    - name: news-crawl-steps
      steps:
      - - name: crawl-news
          template: run-news-crawler
          arguments: { parameters: [{name: cmd, value: "python -m ml.crawl_news --all --max-pages 2 --hours 1"}] }

    - name: run-news-crawler
      inputs:
        parameters: [{name: cmd}]
      container:
        image: stocksense-ml:latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args: ["{{inputs.parameters.cmd}}"]
        env:
        - name: TZ
          value: "Asia/Seoul"
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: stocksense-config
              key: DATABASE_URL
