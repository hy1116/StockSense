apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: db-migration-
  namespace: stocksense
  labels:
    app: db-migration
spec:
  entrypoint: migration-entry # 실행 시작점 정의
  
  serviceAccountName: argo-workflow
    
  # Argo 전용 TTL 전략 (성공/실패 분기)
  ttlStrategy:
    secondsAfterSuccess: 60
    secondsAfterFailure: 3600

  templates:
  - name: migration-entry
    # 1단계: DB 대기, 2단계: 마이그레이션 실행
    steps:
    - - name: wait
        template: wait-for-db
    - - name: migrate
        template: run-alembic

  # DB 대기 템플릿
  - name: wait-for-db
    container:
      image: busybox:1.36
      command: ['sh', '-c']
      args: ['until nc -z postgres-service 5432; do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"']

  # 실제 마이그레이션 실행 템플릿
  - name: run-alembic
    container:
      image: stocksense-backend:latest
      imagePullPolicy: IfNotPresent
      command: ["alembic", "upgrade", "head"]
      env:
      - name: DATABASE_URL
        valueFrom:
          configMapKeyRef:
            name: stocksense-config
            key: DATABASE_URL
      - name: POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: stocksense-secret
            key: POSTGRES_PASSWORD
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "256Mi"
          cpu: "200m"