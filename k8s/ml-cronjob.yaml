apiVersion: batch/v1
kind: CronJob
metadata:
  name: ml-pipeline
  namespace: stocksense
spec:
  schedule: "0 6 * * 1-5"  # 평일 오전 6시 (KST 기준 조정 필요)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: ml-worker
        spec:
          restartPolicy: OnFailure
          containers:
          - name: ml-worker
            image: stocksense-worker:latest
            imagePullPolicy: IfNotPresent
            env:
            - name: DATABASE_URL
              valueFrom:
                configMapKeyRef:
                  name: stocksense-config
                  key: DATABASE_URL
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: stocksense-config
                  key: REDIS_HOST
            - name: REDIS_PORT
              valueFrom:
                configMapKeyRef:
                  name: stocksense-config
                  key: REDIS_PORT
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: stocksense-secret
                  key: POSTGRES_PASSWORD
            volumeMounts:
            - name: models-storage
              mountPath: /app/models
            - name: data-storage
              mountPath: /app/data
            - name: log-storage
              mountPath: /app/logs
          volumes:
          - name: models-storage
            persistentVolumeClaim:
              claimName: models-pvc
          - name: data-storage
            persistentVolumeClaim:
              claimName: data-pvc
          - name: log-storage
            persistentVolumeClaim:
              claimName: ml-log-pvc
