# Database Migration Job
# 백엔드/ML 배포 전에 이 Job을 먼저 실행하여 DB 스키마를 생성/업데이트합니다.
# 사용법: kubectl apply -f k8s/db-migration-job.yaml
#
# 주의: 백엔드와 ML이 각각 올라가더라도, 마이그레이션은 이 Job에서만 실행됩니다.
# 여러 Pod에서 동시에 마이그레이션을 실행하면 충돌이 발생할 수 있으므로,
# 반드시 이 Job을 먼저 실행한 후 백엔드/ML을 배포하세요.
---
apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  namespace: stocksense
  labels:
    app: db-migration
spec:
  # 실패 시 재시도 횟수
  backoffLimit: 3
  # Job 완료 후 자동 삭제 (초 단위, 1시간 후 삭제)
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: db-migration
    spec:
      restartPolicy: Never
      # PostgreSQL이 준비될 때까지 대기
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z postgres-service 5432; do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"']
      containers:
      - name: migration
        image: stocksense-backend:latest
        imagePullPolicy: IfNotPresent
        command: ["alembic", "upgrade", "head"]
        env:
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: stocksense-config
              key: DATABASE_URL
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: stocksense-secret
              key: POSTGRES_PASSWORD
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
---
# 수집 종목 초기 데이터 설정 Job (선택사항)
# 마이그레이션 후 collection_stocks 테이블에 기본 종목을 추가합니다.
apiVersion: batch/v1
kind: Job
metadata:
  name: init-collection-stocks
  namespace: stocksense
  labels:
    app: init-collection-stocks
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: init-collection-stocks
    spec:
      restartPolicy: Never
      containers:
      - name: init-stocks
        image: stocksense-ml:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "-m", "ml.init_collection_stocks", "--init"]
        env:
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: stocksense-config
              key: DATABASE_URL
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: stocksense-secret
              key: POSTGRES_PASSWORD
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
